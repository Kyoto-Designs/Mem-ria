import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  Plus, Star, Archive, ChevronLeft, MoreVertical, Check, Trash2,
  Inbox, Settings, Type, Volume2, Eye, Printer, Share2, 
  Coffee, Moon, Leaf, Heart, Layout, Zap, Cloud, Smartphone,
  Info, Sparkles, Download, FileText, Globe, Languages, X as CloseIcon
} from 'lucide-react';

// --- Dicionário de Idiomas (Principais do Mundo) ---
const LANGUAGES = {
  pt: { name: 'Português', welcome: 'Ajuste o app do seu jeito.', pile: 'Pilha', all: 'Todas', fav: 'Favoritas', arch: 'Arquivo', set: 'Ajustes', print: 'Transformar em Papel', save: 'Guardar', title: 'Título...', write: 'O que sua alma diz?', delete: 'Apagar', theme: 'Estética Visual', texture: 'Textura do Papel', anim: 'Ritmo', lang: 'Idioma' },
  en: { name: 'English', welcome: 'Adjust it your way.', pile: 'Stack', all: 'All', fav: 'Favorites', arch: 'Archive', set: 'Settings', print: 'Turn into Paper', save: 'Save', title: 'Title...', write: 'What is on your mind?', delete: 'Delete', theme: 'Visual Aesthetics', texture: 'Paper Texture', anim: 'Pace', lang: 'Language' },
  es: { name: 'Español', welcome: 'Ajústalo a tu manera.', pile: 'Pila', all: 'Todas', fav: 'Favoritas', arch: 'Archivo', set: 'Ajustes', print: 'Convertir en Papel', save: 'Guardar', title: 'Título...', write: '¿Qué dice tu alma?', delete: 'Borrar', theme: 'Estética Visual', texture: 'Textura del Papel', anim: 'Ritmo', lang: 'Idioma' },
  fr: { name: 'Français', welcome: 'Ajustez à votre guise.', pile: 'Pile', all: 'Toutes', fav: 'Favorites', arch: 'Archives', set: 'Réglages', print: 'Transformer en Papier', save: 'Enregistrer', title: 'Titre...', write: 'Que dit votre âme ?', delete: 'Supprimer', theme: 'Esthétique Visuelle', texture: 'Texture du Papier', anim: 'Rythme', lang: 'Langue' },
  de: { name: 'Deutsch', welcome: 'Passe es nach deinen Wünschen an.', pile: 'Stapel', all: 'Alle', fav: 'Favoriten', arch: 'Archiv', set: 'Optionen', print: 'In Papier verwandeln', save: 'Speichern', title: 'Titel...', write: 'Was beschäftigt dich?', delete: 'Löschen', theme: 'Visuelle Ästhetik', texture: 'Papiertextur', anim: 'Tempo', lang: 'Sprache' },
  it: { name: 'Italiano', welcome: 'Regolalo a modo tuo.', pile: 'Pila', all: 'Tutte', fav: 'Preferite', arch: 'Archivio', set: 'Impostazioni', print: 'Trasforma in Carta', save: 'Salva', title: 'Titolo...', write: 'Cosa dice la tua anima?', delete: 'Elimina', theme: 'Estetica Visiva', texture: 'Trama della Carta', anim: 'Ritmo', lang: 'Lingua' },
  ja: { name: '日本語', welcome: 'あなたらしく調整してください。', pile: '積み重ね', all: 'すべて', fav: 'お気に入り', arch: 'アーカイブ', set: '設定', print: '紙に変える', save: '保存', title: 'タイトル...', write: '心に何がありますか？', delete: '削除', theme: '視覚美', texture: '紙の質感', anim: 'ペース', lang: '言語' },
  zh: { name: '中文', welcome: '按你喜欢的方式调整。', pile: '叠放', all: '全部', fav: '收藏', arch: '归档', set: '设置', print: '化为纸张', save: '保存', title: '标题...', write: '你的灵魂在诉说着什么？', delete: '删除', theme: '视觉审美', texture: '纸张纹理', anim: '节奏', lang: '语言' },
  ru: { name: 'Русский', welcome: 'Настройте под себя.', pile: 'Стопка', all: 'Все', fav: 'Избранное', arch: 'Архив', set: 'Настройки', print: 'Превратить в бумагу', save: 'Сохранить', title: 'Заголовок...', write: 'Что у вас на душе?', delete: 'Удалить', theme: 'Эстетика', texture: 'Текстура бумаги', anim: 'Ритм', lang: 'Язык' },
  ar: { name: 'العربية', welcome: 'اضبطه بطريقتك.', pile: 'مجموعة', all: 'الكل', fav: 'المفضلة', arch: 'الأرشيف', set: 'الإعدادات', print: 'تحويل إلى ورق', save: 'حفظ', title: 'العنوان...', write: 'ماذا يدور في ذهنك؟', delete: 'حذف', theme: 'الجمالية البصرية', texture: 'نسيج الورق', anim: 'سرعة', lang: 'اللغة' },
  hi: { name: 'हिन्दी', welcome: 'इसे अपने तरीके से समायोजित करें।', pile: 'ढेर', all: 'सब', fav: 'पसंदीदा', arch: 'संग्रह', set: 'सेटिंग्स', print: 'कागज में बदलें', save: 'सहेजें', title: 'शीर्षक...', write: 'आपके मन में क्या है?', delete: 'मिटाएं', theme: 'दृश्य सौंदर्य', texture: 'कागज की बनावट', anim: 'ताल', lang: 'भाषा' },
  ko: { name: '한국어', welcome: '당신만의 방식으로 조정하세요.', pile: '더미', all: '모두', fav: '즐겨찾기', arch: '보관함', set: '설정', print: '종이로 바꾸기', save: '저장', title: '제목...', write: '무슨 생각을 하시나요?', delete: '삭제', theme: '시각적 미학', texture: '종이 질감', anim: '속도', lang: '언어' },
  // ... (Outros idiomas como TR, NL, PL, SV, FI, DA, NO, ID, TH, VI, EL, HE, HU, CS, RO, UK seriam listados aqui)
};

const THEMES = {
  paper: { id: 'paper', name: 'Paper', bg: '#f4f1ea', card: '#fffdfa', accent: '#8b7e6a', text: '#4a453e', texture: 'paper-fibers', font: 'serif' },
  midnight: { id: 'midnight', name: 'Midnight', bg: '#12141d', card: '#1e212d', accent: '#6366f1', text: '#e2e8f0', texture: 'dark-matter', font: 'sans' },
  cardboard: { id: 'cardboard', name: 'Cardboard', bg: '#c5a880', card: '#d9b991', accent: '#5d4037', text: '#3e2723', texture: 'cardboard', font: 'handwriting' },
  coffee: { id: 'coffee', name: 'Coffee', bg: '#ebe3d5', card: '#f3eee5', accent: '#7b3f00', text: '#3e2723', texture: 'paper-fibers', font: 'serif' }
};

const App = () => {
  const [view, setView] = useState('home'); 
  const [activeTab, setActiveTab] = useState('all'); 
  const [currentTheme, setCurrentTheme] = useState(THEMES.paper);
  const [isExporting, setIsExporting] = useState(null);
  
  // Detecção de Idioma Inicial
  const [langCode, setLangCode] = useState(() => {
    const sysLang = navigator.language.split('-')[0];
    return LANGUAGES[sysLang] ? sysLang : 'en';
  });

  const t = LANGUAGES[langCode] || LANGUAGES.en;

  const [settings, setSettings] = useState({
    showLines: true,
    animations: 'calm',
    textureIntensity: 50,
  });
  
  const [notes, setNotes] = useState([
    { id: 1, title: 'Ideia 01', content: 'As palavras flutuam no papel...', date: '07 Fev', favorite: true, archived: false, x: -1, y: -1, rotate: -1 },
  ]);
  
  const [activeNote, setActiveNote] = useState(null);
  const [isCrumpling, setIsCrumpling] = useState(false);

  const actions = {
    toggleFavorite: (id) => setNotes(notes.map(n => n.id === id ? { ...n, favorite: !n.favorite } : n)),
    toggleArchive: (id) => setNotes(notes.map(n => n.id === id ? { ...n, archived: !n.archived } : n)),
    deleteNote: (id) => setNotes(notes.filter(n => n.id !== id))
  };

  return (
    <div className="min-h-screen transition-colors duration-700 overflow-hidden" style={{ backgroundColor: currentTheme.bg, color: currentTheme.text }}>
      <div className="fixed inset-0 pointer-events-none z-0 transition-opacity duration-1000"
           style={{ opacity: settings.textureIntensity / 200, backgroundImage: `url('https://www.transparenttextures.com/patterns/${currentTheme.texture}.png')`, filter: currentTheme.id === 'midnight' ? 'invert(1)' : 'none' }} />

      <AnimatePresence mode="wait">
        {view === 'home' && (
          <HomeView 
            t={t} notes={notes.filter(n => activeTab === 'all' ? !n.archived : activeTab === 'fav' ? n.favorite && !n.archived : n.archived)} 
            activeTab={activeTab} setActiveTab={setActiveTab} currentTheme={currentTheme} setCurrentTheme={setCurrentTheme} 
            settings={settings} setSettings={setSettings} langCode={langCode} setLangCode={setLangCode}
            onNoteClick={(note) => { setActiveNote(note); setView('editing'); }}
            onCreate={() => { setIsCrumpling(true); setTimeout(() => { setIsCrumpling(false); setView('editing'); setActiveNote({id: Date.now(), title: '', content: '', date: t.pile, x:0, y:0, rotate:0}); }, 1200); }}
            isCrumpling={isCrumpling} actions={actions}
          />
        )}
        {view === 'editing' && (
          <NoteEditor t={t} note={activeNote} settings={settings} currentTheme={currentTheme} onBack={() => setView('home')} onSave={(n) => { setNotes([n, ...notes.filter(x => x.id !== n.id)]); setView('home'); }} onExport={() => setIsExporting(activeNote)} />
        )}
      </AnimatePresence>

      <AnimatePresence>
        {isExporting && <ExportModal t={t} note={isExporting} onClose={() => setIsExporting(null)} currentTheme={currentTheme} />}
      </AnimatePresence>
    </div>
  );
};

const HomeView = ({ t, notes, activeTab, setActiveTab, currentTheme, setCurrentTheme, settings, setSettings, langCode, setLangCode, onNoteClick, onCreate, isCrumpling, actions }) => (
  <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }} className="relative z-10 flex flex-col h-screen max-w-5xl mx-auto p-4 md:p-8">
    <header className="flex flex-col md:flex-row md:items-end justify-between mb-8 gap-4">
      <div className="space-y-1">
        <h1 className="text-4xl font-serif italic tracking-tighter">Memórias</h1>
        <p className="text-[10px] opacity-40 uppercase tracking-widest font-bold">{t.pile}: {notes.length}</p>
      </div>
      <nav className="flex bg-black/5 p-1 rounded-2xl overflow-x-auto no-scrollbar">
        {[{ id: 'all', l: t.all, i: Inbox }, { id: 'fav', l: t.fav, i: Star }, { id: 'arch', l: t.arch, i: Archive }, { id: 'settings', l: t.set, i: Settings }].map((tab) => (
          <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-bold transition-all ${activeTab === tab.id ? 'bg-white shadow-md' : 'opacity-40'}`} style={{ color: activeTab === tab.id ? currentTheme.accent : 'inherit' }}>
            <tab.i size={14} fill={activeTab === tab.id && tab.id !== 'settings' ? 'currentColor' : 'none'} /> {tab.l}
          </button>
        ))}
      </nav>
    </header>

    <div className="flex-1 overflow-y-auto">
      {activeTab === 'settings' ? (
        <SettingsPanel t={t} settings={settings} setSettings={setSettings} currentTheme={currentTheme} setCurrentTheme={setCurrentTheme} langCode={langCode} setLangCode={setLangCode} />
      ) : (
        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-6 pb-40">
          {notes.map(note => <NoteCard key={note.id} note={note} onClick={() => onNoteClick(note)} actions={actions} currentTheme={currentTheme} />)}
          <button onClick={onCreate} className="aspect-[1/1.2] border-2 border-dashed border-black/10 rounded-sm flex items-center justify-center opacity-20 hover:opacity-50 transition-opacity"><Plus size={32} /></button>
        </div>
      )}
    </div>
    {isCrumpling && <CrumpleAnimation theme={currentTheme} />}
  </motion.div>
);

const SettingsPanel = ({ t, settings, setSettings, currentTheme, setCurrentTheme, langCode, setLangCode }) => (
  <motion.div initial={{ y: 20 }} animate={{ y: 0 }} className="max-w-2xl mx-auto space-y-10 pb-20">
    <div className="text-center py-6"><p className="font-serif italic text-xl">"{t.welcome}"</p></div>

    <section className="space-y-4">
      <label className="text-[10px] font-bold opacity-40 uppercase tracking-widest flex items-center gap-2"><Globe size={14} /> {t.lang}</label>
      <select value={langCode} onChange={(e) => setLangCode(e.target.value)} className="w-full p-4 bg-black/5 rounded-2xl border-none outline-none font-bold text-sm cursor-pointer appearance-none">
        {Object.entries(LANGUAGES).map(([code, lang]) => (
          <option key={code} value={code}>{lang.name}</option>
        ))}
      </select>
    </section>

    <section className="space-y-4">
      <label className="text-[10px] font-bold opacity-40 uppercase tracking-widest flex items-center gap-2"><Sparkles size={14} /> {t.theme}</label>
      <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
        {Object.values(THEMES).map(theme => (
          <button key={theme.id} onClick={() => setCurrentTheme(theme)} className={`p-4 rounded-xl border-2 transition-all flex flex-col items-center gap-2 ${currentTheme.id === theme.id ? 'border-current' : 'border-transparent bg-black/5 opacity-60'}`}>
            <div className="w-8 h-8 rounded-full shadow-inner" style={{ backgroundColor: theme.bg }}></div>
            <span className="text-[8px] font-bold uppercase">{theme.name}</span>
          </button>
        ))}
      </div>
    </section>

    <section className="bg-black/5 rounded-2xl p-6 space-y-6">
      <div className="flex justify-between items-center text-xs font-bold">
        <span className="opacity-60">{t.texture}</span>
        <input type="range" min="0" max="100" value={settings.textureIntensity} onChange={(e) => setSettings({...settings, textureIntensity: parseInt(e.target.value)})} className="w-32 accent-current" />
      </div>
      <div className="flex justify-between items-center text-xs font-bold">
        <span className="opacity-60">{t.anim}</span>
        <div className="flex bg-black/5 p-1 rounded-lg">
          {['calm', 'snappy'].map(m => <button key={m} onClick={() => setSettings({...settings, animations: m})} className={`px-4 py-1 rounded-md text-[8px] uppercase ${settings.animations === m ? 'bg-white shadow-sm' : 'opacity-30'}`}>{m}</button>)}
        </div>
      </div>
    </section>
  </motion.div>
);

const NoteCard = ({ note, onClick, actions, currentTheme }) => (
  <motion.div layout animate={{ x: note.x, y: note.y, rotate: note.rotate }} onClick={onClick} className="relative aspect-[1/1.2] p-4 shadow-sm border rounded-sm group cursor-pointer flex flex-col" style={{ backgroundColor: currentTheme.card, borderColor: 'rgba(0,0,0,0.05)' }}>
    <span className="text-[8px] uppercase font-bold opacity-20 mb-2">{note.date}</span>
    <h3 className="font-serif text-sm font-bold mb-1 line-clamp-2">{note.title || '...'}</h3>
    <p className="text-[10px] opacity-40 leading-relaxed line-clamp-4 font-handwriting">{note.content}</p>
  </motion.div>
);

const NoteEditor = ({ t, note, settings, currentTheme, onBack, onSave, onExport }) => {
  const [title, setTitle] = useState(note.title);
  const [content, setContent] = useState(note.content);
  return (
    <motion.div initial={{ y: '100%' }} animate={{ y: 0 }} className="fixed inset-0 z-[100] flex flex-col md:max-w-4xl md:mx-auto md:my-4 md:rounded-sm shadow-2xl" style={{ backgroundColor: currentTheme.card, color: currentTheme.text }}>
      <header className="flex justify-between items-center px-4 py-3 border-b border-black/5">
        <button onClick={onBack} className="p-2 opacity-40"><ChevronLeft /></button>
        <div className="flex gap-4">
          <button onClick={onExport} className="p-2 opacity-40"><Printer size={18}/></button>
          <button onClick={() => onSave({...note, title, content})} className="bg-current text-white px-6 py-1.5 rounded-full text-xs font-bold" style={{ backgroundColor: currentTheme.accent }}>{t.save}</button>
        </div>
      </header>
      <div className={`flex-1 p-6 md:p-12 overflow-y-auto ${settings.showLines ? 'notebook-lines' : ''}`}>
        <input value={title} onChange={(e) => setTitle(e.target.value)} placeholder={t.title} className="w-full text-3xl font-serif italic bg-transparent border-none outline-none mb-6" />
        <textarea value={content} onChange={(e) => setContent(e.target.value)} placeholder={t.write} className="w-full h-full bg-transparent border-none outline-none resize-none text-lg leading-[2rem] font-handwriting" />
      </div>
    </motion.div>
  );
};

const ExportModal = ({ t, note, onClose, currentTheme }) => (
  <div className="fixed inset-0 z-[300] bg-black/60 backdrop-blur-xl flex items-center justify-center p-4">
    <div className="bg-[#f4f1ea] text-[#4a453e] w-full max-w-lg rounded-2xl p-8 shadow-2xl space-y-8">
      <div className="flex justify-between items-center"><h3 className="font-bold uppercase text-[10px] tracking-widest opacity-40">{t.print}</h3><button onClick={onClose}><CloseIcon size={18}/></button></div>
      <div className="aspect-[1/1.4] bg-white shadow-xl mx-auto w-48 p-4 flex flex-col">
        <div className="h-4 bg-gray-100 w-2/3 mb-2"></div><div className="h-1 bg-gray-50 w-full mb-1"></div><div className="h-1 bg-gray-50 w-full"></div>
      </div>
      <button className="w-full bg-[#8b7e6a] text-white py-4 rounded-xl font-bold text-xs" onClick={onClose}>{t.print}</button>
    </div>
  </div>
);

const CrumpleAnimation = ({ theme }) => (
  <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/5 backdrop-blur-sm">
    <motion.div animate={{ scale: [0, 1.1, 1], rotate: [20, -10, 0] }} className="w-56 h-72 shadow-2xl border bg-white" />
  </div>
);

export default App;

          
